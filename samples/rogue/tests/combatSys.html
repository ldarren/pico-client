<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<link rel="shortcut icon" type="image/x-icon" href=../res/img/favicon.ico>
<link rel=stylesheet href=../css/fantasy.css>
<style>
div.panel{
    color:#aec440;
    border: 3px solid #d7e894;
    border-radius: 2em/2em;
    margin:5px;
    padding:5px;
}
div.left{
    float:left;
}
div#gameStage{
}
</style>
<title>Rogue Combat System</title>
</head>
<body>
<div class=left>
<div id=player class=panel>Player Type: Rogue</div>
<div id=selected class=panel>Selected Type: Creep</div>
<div id=result class=panel>Result:</div>
</div>
<div id=gameStage class=left></div>
<script src=../lib/pico/pico.js></script>
<script src=../lib/pico/lib/piAtlas.js></script>
<script src=../lib/pico/lib/piCanvas.js></script>
<script src=../lib/pico/lib/piReactor.js></script>
<script src=../lib/pico/lib/picRenderer.js></script>
<script src=../js/const.js></script>
<script templ=player type=text/templ>
type: TYPE<br>
level: LEVEL<br>
theme: THEME<br>
</script>
<script>
pico.def('camera', 'picBase', function(){
    var me = this;
    me.draw = function(ctx, ent, clip){
        var ts = this.tileSet;
        ts.draw(ctx, G_HERO.ROGUE, 0, 0);
    };
});
pico.def('game', 'picGroup', function(){
    var
    me = this,
    panelPlayer = document.querySelector('div#player'),
    templPlayer = document.querySelector('script[templ=player]').textContent,
    getMapSize = function(level){
        var
        w = 8 + Math.floor(level/10),
        h = 8 + Math.floor((level-5)/10);
        return [w, h];
    },
    getCreepCount = function(level, w, h){
        return Math.floor(w*h*(0.1+(level/1000))+(level/5));
    },
    getChestCount = function(level){
        return Math.floor(w*h*(0.01+(level/2000))+(level/5));
    };

    this.maxLevel = this.level = 0,
    this.tileSet = null;

    me.init = function(option){
        this.tileSet = option.tileSet;
        this.level = option.mapLevel || 1;
        if (this.level > this.maxLevel) this.maxLevel = this.level;
    };

    me.reset = function(elapsed, evt, entities){
        panelPlayer.innerHTML = templPlayer.replace('TYPE', evt.type).replace('LEVEL', evt.level).replace('THEME', evt.theme);
        return entities;
    };
});
pico.def('combatSysMain', function(){
    this.use('piCanvas');
    this.use('piReactor');
    this.use('piAtlas');
    this.use('picRenderer');
    this.use('game');
    this.use('camera');

    var
    me = this,
    gameSetting,
    onFingerUp = function(evt){
    },
    onLoad = function(){
        me.piAtlas.create('../res/img/fantasy-tileset.png', '../res/fantasy-tileset.json', function(err, tileSet){
            if (err) return alert(err);

            var
            gameStage = document.querySelector('div#gameStage'),
            reactor = me.piReactor,
            rect = me.picRect,
            renderer = me.picRenderer,
            game = me.game,
            camera = me.camera,
            canvas = me.piCanvas,
            h = window.innerHeight,
            w = Math.ceil(0.8 * h);

            gameStage.style.width = w+'px';
            gameStage.style.height = h+'px';

            canvas.init(gameStage);

            var gameLayer = canvas.addLayer('game');
            renderer.registerContext('viewPane', gameLayer.getContext());
            renderer.setBG('viewPane', G_COLOR_TONE[3]);
        
            reactor.addGroup(game);

            game.init({tileSet:tileSet, mapLevel:0});
            game.route('testReset', [game.reset, renderer.draw]);
/*
            game.route('fingerDown', [uiWindow.checkBound, camera.checkBound, game.captureSelected, renderer.captureScreenshot]);
            game.route('fingerUp', [game.useSelected, bag.click, dialogMsg.click, uiWindow.click, camera.click, renderer.draw, game.releaseSelected]);
            game.route('fingerMove', [game.useSelected, uiWindow.swipe, camera.swipe, renderer.drawScreenshot]);
            game.route('fingerOut', [game.releaseSelected, renderer.releaseScreenshot, renderer.draw]);
            game.route('useItem', [bag.useItem, renderer.draw, game.releaseSelected]);
            game.route('gotoLevel', [game.gotoLevel, renderer.draw]);
            game.route('reborn', [game.reborn, renderer.draw]);
*/

            var cameraEnt = game.addEntity('camera');
            cameraEnt.attach(renderer, {viewPane:[camera.moduleName]});

            canvas.resize(w, h);
            renderer.resizeContext('viewPane', 0, 0, w, h);

            canvas.slot(canvas.FINGER_UP, onFingerUp);
            if (gameSetting) game.go('testReset', gameSetting);
        });
    },
    onGameSet = function(obj, state){
        gameSetting = obj;
        console.log('onGameSet', JSON.stringify(obj));
        if (me.game.host) me.game.go('testReset', obj);
    };

    me.slot(pico.LOAD, onLoad);
    pico.slot(pico.STATE_CHANGE, onGameSet);
});
</script>
</body>
</html>
