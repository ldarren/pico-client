<style>
div#gameStage{
    position:absolute;
    left: 50%
}
</style>
<div id=gameStage></div>

<script name=gamePage>
this.use('piCanvas');
this.use('piReactor');
this.use('piAtlas');
this.use('picRect');
this.use('picTween');
this.use('picRenderer');
this.use('rogueMain');
this.use('game');
this.use('camera');
this.use('uiWindow');
this.use('hero');
this.use('bag');
this.use('tome');
this.use('info');
this.use('dialogMsg');
this.use('trade');

var
me = this,
gameStage,
fingerStartPos = [0, 0],
fingerTracker,
cancelTracking = function(){
    me.game.stopLoop('fingerMove');
    me.game.go('fingerOut');
    fingerTracker = undefined;
},
onFingerDown = function(evt, x, y){
    fingerStartPos[0] = x;
    fingerStartPos[1] = y;
    me.game.go('fingerDown', [x, y]);
},
onFingerUp = function(evt, x, y){
    if (fingerTracker) return cancelTracking() // is a move not a click
    me.game.go('fingerUp', [x, y]);
},
onFingerTwice = function(evt, x, y){
    if (fingerTracker) return cancelTracking() // is a move not a click
    me.game.go('fingerTwice', [x, y]);
},
onFingerMove = function(evt, x, y){
    if (fingerTracker){
        fingerTracker[0] = x;
        fingerTracker[1] = y;
    }else{
        fingerTracker = [x, y, fingerStartPos[0], fingerStartPos[1]];
        me.game.startLoop('fingerMove', fingerTracker);
    }
},
onFingerOut = function(evt, x, y){
    cancelTracking();
},
resize = function(iw, ih){
    var
    style = gameStage.style,
    h, w;

    if (ih > iw){
        w = h = ih;
        //w = Math.ceil(0.8 * h);
        if (w > iw) w = iw;
    }else{
        h = w = iw;
        //h = Math.ceil(0.8 * w);
        if (h > ih) h = ih;
    }

    style.width = w + 'px';
    style.height = h + 'px';
    style.margin = '0 0 0 '+Math.floor(-w/2)+'px';

    me.piCanvas.resize();
    me.picRenderer.resizeContext('viewPane', 0, 0, w, h);
    me.picRenderer.resizeContext('uiPane', 0, 0, w, h);
    me.game.go('resize', [0,0,w,h]);
},
onResize = function(){
    resize(this.innerWidth, this.innerHeight);
},
onLoad = function(){
    me.piAtlas.create('dat/img/fantasy-tileset-combined.png', 'dat/fantasy-tileset.json', function(err, tileSet){
        if (err) return alert(err);

        gameStage = document.querySelector('div#gameStage');

        var
        reactor = me.piReactor,
        rect = me.picRect,
        renderer = me.picRenderer,
        game = me.game,
        camera = me.camera,
        uiWindow = me.uiWindow,
        bag = me.bag,
        tome = me.tome,
        info = me.info,
        hero = me.hero,
        dialogMsg = me.dialogMsg,
        trade = me.trade,
        canvas = me.piCanvas,
        smallDevice = window.innerWidth > 800 || window.innerHeight > 800 ? false : true;

        canvas.init(gameStage);

        var
        gameLayer = canvas.addLayer('game'),
        uiLayer = canvas.addLayer('ui');

        renderer.registerContext('viewPane', gameLayer.getContext());
        renderer.registerContext('uiPane', uiLayer.getContext());
        renderer.setBG('viewPane', G_COLOR_TONE[2]);

        reactor.addGroup(game);

        game.init({tileSet:tileSet, smallDevice: smallDevice});

        game.route('fingerDown', game.route('fingerDownFull', [
            uiWindow.checkBound,
            info.checkBound,
            dialogMsg.checkBound,
            trade.checkBound,
            camera.checkBound,
            game.captureSelected,
            renderer.captureScreenshot
        ]));
        game.route('fingerUp', game.route('fingerUpFull', [
            game.useSelected, 
            game.releaseSelected, 
            info.click,
            tome.click, 
            bag.click, 
            dialogMsg.click, 
            trade.click, 
            uiWindow.click, 
            camera.click, 
            renderer.draw
        ]);
        game.route('fingerTwice', [
            game.useSelected, 
            game.releaseSelected, 
            info.doubleClick,
        ]);
        game.route('fingerMove', [game.useSelected, uiWindow.swipe, camera.swipe, renderer.drawScreenshot]);
        game.route('fingerOut', [game.releaseSelected, renderer.releaseScreenshot, renderer.draw]);
        game.route('useItem', [bag.useItem, renderer.draw, game.releaseSelected]);
        game.route('selectSpell', [tome.selectSpell, renderer.draw, game.releaseSelected]);
        game.route('openGate', [game.openGate, renderer.draw]);
        game.route('openChest', [game.openChest, renderer.draw]);
        game.route('loot', [bag.lootItem, renderer.draw]);
        game.route('chant', [game.chantScroll, renderer.draw]);
        game.route('attack', [game.attackAnim, renderer.draw]);
        game.route('counter', [game.counterAnim, renderer.draw]);
        game.route('flee', [game.flee, renderer.draw]);
        game.route('gameStep', [game.step, renderer.draw]);
        game.route('forceRefresh', [renderer.draw]);
        game.route('resize', [
            camera.resize, 
            uiWindow.resize, 
            tome.resize, 
            bag.resize,
            info.resize,
            dialogMsg.resize,
            trade.resize,
            renderer.draw
        ]);
        game.route('heroMoveTo', [game.heroMoveTo]);
        game.route('heroMove', [game.heroMove, renderer.draw]);
        game.route('heroStop', [game.heroStop, renderer.draw]);
        game.route('gotoLevel', [game.gotoLevel, renderer.draw]);
        game.route('teleport', [game.teleport, renderer.draw]);
        game.route('reborn', [game.reborn, renderer.draw]);
        game.route('recover', [game.recover, renderer.draw]);
        game.route('openForSale', [uiWindow.openForSale, bag.openForSale, renderer.draw]);
        game.route('showInfo', [info.open, renderer.draw]);
        game.route('hideInfo', [info.close, renderer.draw]);
        game.route('showDialog', [dialogMsg.open, uiWindow.hideAll, renderer.draw, game.releaseSelected]);
        game.route('hideDialog', [dialogMsg.close, uiWindow.showAll, renderer.draw, game.releaseSelected]);
        game.route('showTrade', [game.createGoods, trade.open, uiWindow.hideAll, renderer.draw, game.releaseSelected]);
        game.route('hideTrade', [trade.close, uiWindow.showAll, renderer.draw, game.releaseSelected]);

        var
        cameraEnt = game.addEntity('camera'),
        uiWinEnts = [],
        uiWinEnt;

        cameraEnt.attach(rect, {x:0, y:0, width:100, height:100});
        cameraEnt.attach(camera, {});
        cameraEnt.attach(renderer, {viewPane:[camera.moduleName]});

        uiWinEnts[0] = game.addEntity(G_WIN_ID.PLAYER);
        uiWinEnts[1] = game.addEntity(G_WIN_ID.TOME);
        uiWinEnts[2] = game.addEntity(G_WIN_ID.BAG);

        for(var i=0, l=uiWinEnts.length; i<l; i++){
            uiWinEnt = uiWinEnts[i];
            uiWinEnt.attach(rect, {x:0, y:0, width:0, height:0});
            uiWinEnt.attach(uiWindow, {theme: G_THEME.THEME8, background: G_COLOR_TONE[3], box:rect.moduleName});
        }
        uiWinEnt = uiWinEnts[0];
        uiWinEnt.attach(hero, {win:uiWindow.moduleName, fontBig:'bold 12pt alagard', fontSmall:'8pt alagard', fontColor:G_COLOR_TONE[1]});
        uiWinEnt.attach(renderer, {uiPane:[uiWindow.moduleName, hero.moduleName]});
        uiWinEnt = uiWinEnts[1];
        uiWinEnt.attach(tome, {name:'Tome', win:uiWindow.moduleName, fontBig:'bold 12pt alagard', fontSmall:'8pt alagard', fontColor:G_COLOR_TONE[1]});
        uiWinEnt.attach(renderer, {uiPane:[uiWindow.moduleName, tome.moduleName]});
        uiWinEnt = uiWinEnts[2];
        uiWinEnt.attach(bag, {name:'Bag', win:uiWindow.moduleName, fontBig:'bold 12pt alagard', fontSmall:'8pt alagard', fontColor:G_COLOR_TONE[1]});
        uiWinEnt.attach(renderer, {uiPane:[uiWindow.moduleName, bag.moduleName]});

        uiWinEnt = game.addEntity(G_WIN_ID.INFO);
        uiWinEnt.attach(rect, {x:0, y:0, width:0, height:0});
        uiWinEnt.attach(info, {box:rect.moduleName, fontBig:'bold 12pt alagard', fontSmall:'8pt alagard', background:G_SHADE[3]});
        uiWinEnt.attach(renderer, {uiPane:[info.moduleName]});

        uiWinEnt = game.addEntity(G_WIN_ID.DIALOG);
        uiWinEnt.attach(rect, {x:0, y:0, width:0, height:0});
        uiWinEnt.attach(dialogMsg, {box:rect.moduleName, fontBig:'bold 14pt alagard', fontSmall:'10pt alagard', background:G_SHADE[3]});
        uiWinEnt.attach(renderer, {uiPane:[dialogMsg.moduleName]});

        uiWinEnt = game.addEntity(G_WIN_ID.TRADE);
        uiWinEnt.attach(rect, {x:0, y:0, width:0, height:0});
        uiWinEnt.attach(trade, {box:rect.moduleName, fontBig:'bold 14pt alagard', fontSmall:'10pt alagard', background:G_SHADE[3]});
        uiWinEnt.attach(renderer, {uiPane:[trade.moduleName]});

        resize(window.innerWidth, window.innerHeight);
        canvas.slot(canvas.FINGER_DOWN, onFingerDown);
        canvas.slot(canvas.FINGER_MOVE, onFingerMove);
        canvas.slot(canvas.FINGER_UP, onFingerUp);
        canvas.slot(canvas.FINGER_TWICE, onFingerTwice);
        canvas.slot(canvas.FINGER_OUT, onFingerOut);
        window.addEventListener('resize', onResize, false);
        window.addEventListener('unload', game.exit, false);

        me.rogueMain.hideLoading();
    });
};

me.slot(pico.LOAD, onLoad);
</script>
