<style>
.fb-connect {
    background:url(css/fb_white_29.png) no-repeat 5px 5px #3b579d;
    display:block;
    line-height:39px;
    outline:medium none;
    text-decoration:none;
    border-radius: 2px 2px;
}
.fb-connect span {
    color:#fff;
    cursor:pointer;
    display:block;
    font-size:14px;
    font-weight:bold;
    margin: 0 0 0 39px;
    width:161px;
    text-height:39px;
    text-align:center;
    font-family: 'Helvetica Neue',Helvetica,Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
}
.fb-connect:active {background-color:#29447e;}

.goog-connect {
    background:url(css/goog_white_32.png) no-repeat 4px 3px #dd4b39;
    display:block;
    line-height:39px;
    outline:medium none;
    text-decoration:none;
    border-radius: 2px 2px;
}
.goog-connect span {
    color:#fff;
    cursor:pointer;
    display:block;
    font-size:14px;
    font-weight:bold;
    border-left: #be3f2b solid 1px;
    margin:0 0 0 39px;
    width:168px;
    text-height:39px;
    text-align:center;
    font-family: 'Helvetica Neue', Helvetica, Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
}
.goog-connect:active {background-color:#c03d28;}
.goog-connect:active span{border-left: #a43422 solid 1px;}

h3{
    margin: 10px auto;
    text-align:center;
    line-height:50px;
}

.hidden{ display:none;}
.shown{ display:block;}

.frame{
    max-width: 512px;
    color:#aec440;
    border: 3px solid #d7e894;
    border-radius: 15px;
    margin:5px auto;
    padding:5px 0 5px 0;
    display:block;
}
.frame h4{
    margin: 0 auto 10px auto;
    text-align:center;
    line-height:20px;
}
.frame div{
    width:200px;
    margin: 10px auto;
}
.frame input[type=text]{
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    line-height:30px;
    text-align:center;
    width:100%;
    height:30px;
}
.frame input[type=checkbox]{
    margin: 0 5px 0 0;
}
</style>

<h3>Dungeon Chronicles</h3>

<div id=gameInfo class=frame>
<h4>Game Info</h4>
<div><a href=# class="fantasyBtn">Connecting...</a></div>
<div><a href=# class="fb-connect hidden"><span>Log In</span></a></div>
<div><input class="hidden" type=text placeholder="Hero Name: Nameless"></input></div>
<div><input type=checkbox>Silence</input></div>
<div><a href=# class="fantasyBtn hidden">Dungeon Map</a></div>
<div><a href=# class="fantasyBtn hidden">Achievements</a></div>
</div>

<div id=cloudSave class="frame hidden">
<h4>Cloud Save</h4>
<div><a href=# class=goog-connect><span>Sign In</span></a></div>
</div>

<div id=encyclopedia class=frame>
<h4>Encyclopedia</h4>
<div><a href=# class=fantasyBtn>Heros</a></div>
<div><a href=# class=fantasyBtn>Creeps</a></div>
<div><a href=# class=fantasyBtn>Spells</a></div>
<div><a href=# class=fantasyBtn>Status Effects</a></div>
</div>

<script name=loginPage>
this.use('rogueMain');
this.use('piHTMLAudio');
this.use('socials');
this.use('game');

var
me = this,
playBtn, fbBtn, gpBtn, nameTextbox, audioSwitch, mapBtn, badgesBtn,
onPlay = function(){
    me.piHTMLAudio.preload();
    me.rogueMain.showLoading();
    me.game.init(nameTextbox.value || 'Nameless');
    pico.changeFrame(document.body, 'div#page', 'html/pageGame.html', {opacity:[0,1,'1s']});
},
onLogin = function(evt){
    me.socials.fbLogin({scope:'publish_actions,user_games_activity'});
},
onSwitchAudio = function(evt){
    me.piHTMLAudio.volume(audioSwitch.checked ? 0 : 1);
},
fbUpdate = function(){
    var socials = me.socials;

    socials.loadNPCs(function(npcs){
        var list = document.querySelector('content.fbProfileList');
        if (!list) return;
        list.innerHTML = '';
        var templ = document.querySelector('script#fbProfile').textContent;
        socials.loadAllies(function(friends){
            var deepest, currLevel, level, row, profile, friend, label;

            for(var i=0,l=friends.length; i<l; i++){
                friend = friends[i];
                for(deepest = list.children.length || 0, currLevel = friend[2]; deepest < currLevel; deepest++){
                    level = document.createElement('span');
                    level.className = 'fantasyRow';

                    row = document.createElement('span');
                    row.className = 'fbProfileRow';
                    level.appendChild(row);

                    label = document.createElement('h5');
                    label.textContent = 'Level '+(deepest+1);
                    level.appendChild(label);

                    list.appendChild(level);
                }
                row = list.querySelector('span:nth-child('+currLevel+') span');
                profile = document.createElement('div');
                profile.className = 'fbProfile';
                profile.innerHTML = templ
                    .replace('PROFILE', socials.fbProfile(friend[0], 42))
                    .replace('NAME', friend[1].split(' ')[0]);
                row.appendChild(profile);
            }
        });
    });
},
onFacebookUpdate = function(userId){
    fbBtn.removeEventListener('click', onLogin);
    playBtn.removeEventListener('click', onPlay);
    var cloudSave = document.querySelector('div#cloudSave');
    if (userId){
        fbBtn.className = 'hidden';
        playBtn.className = 'fantasyBtn';
        playBtn.textContent = 'Begin';
        nameTextbox.removeAttribute('class');
        cloudSave.className = 'frame';
        fbUpdate();
        playBtn.addEventListener('click', onPlay, false);
    }else{
        playBtn.className = 'hidden';
        fbBtn.className = 'fb-connect';
        nameTextbox.className = 'hidden';
        cloudSave.className = 'hidden';
        fbBtn.addEventListener('click', onLogin, false);
    }
},
onLoad = function(){
    debugger;
    var gameInfo = document.querySelector('div#gameInfo');
    playBtn = gameInfo.querySelector('div:nth-of-type(1) a');
    fbBtn = gameInfo.querySelector('div:nth-of-type(2) a');
    nameTextbox = gameInfo.querySelector('div:nth-of-type(3) input');
    audioSwitch = gameInfo.querySelector('div:nth-of-type(4) input');
    mapBtn = gameInfo.querySelector('div:nth-of-type(5) a');
    badgesBtn = gameInfo.querySelector('div:nth-of-type(6) a');

    var name = me.game.load();
    if (name){
      nameTextbox.value = name;
    }

    me.piHTMLAudio.create('dat/fantasy-sfx.json', function(err, audioSprite){
        audioSwitch.addEventListener('click', onSwitchAudio, false);
        me.socials.fbInit(
            '515256841901768', 
            'Phonegap' === pico.states.browser ? CDV.FB : '//dungeon-chronicles.com/rogue/html/fbChannel.html',
            onFacebookUpdate);
        /* if no network */ me.rogueMain.hideLoading();
    });
};

me.slot(pico.LOAD, onLoad);
</script>
