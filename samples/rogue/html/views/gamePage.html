<style>
div#gameStage{
    position:absolute;
    left: 50%
}
</style>
<div id=gameStage></div>

<script name=gamePage>
this.use('piCanvas');
this.use('piReactor');
this.use('piAtlas');
this.use('picRenderer');
this.use('game');
this.use('camera');
this.use('uiPlayer');

var
me = this,
UI_HEIGHT = 200,
UI_WIDTH = 200,
reactor,
canvas,
gameLayer,
cameraEnt, uiPlayer,
onMouseDown = function(evt, x, y){
    reactor.go('move', {x:x, y:y});
},
onResize = function(){
    var
    style = gameStage.style,
    ih = this.innerHeight, iw = this.innerWidth,
    h, w, vw, vh, ux, uy, uw, uh;

    if (ih > iw){
        h = ih;
        w = Math.ceil(0.8 * h);
        if (w > iw) w = iw;

        vw = uw = w;
        uy = vh = h - UI_HEIGHT;
        ux = 0;
        uh = UI_HEIGHT;
    }else{
        w = iw;
        h = Math.ceil(0.8 * w);
        if (h > ih) h = ih;

        vh = uh = h;
        ux = vw = w - UI_WIDTH;
        uy = 0;
        uw = UI_WIDTH;
    }

    style.width = w + 'px';
    style.height = h + 'px';
    style['margin-left'] = Math.floor(-w/2)+'px';

    me.piCanvas.resize(w, h);
    me.picRenderer.resizeContext('viewPane', 0, 0, vw, vh);
    me.picRenderer.resizeContext('uiPane', ux, uy, uw, uh);
    reactor.go('resize', {viewPane:[0, 0, vw, vh], uiPane:[ux, uy, uw, uh]});
},
onRotate = function(evt){
    onResize.call(window);
},
onLoad = function(){
    me.piAtlas.create('../res/img/fantasy-tileset.png', '../res/fantasy-tileset.json', function(err, tileSet){
        if (err) return alert(err);

        var
        gameStage = document.querySelector('div#gameStage'),
        renderer = me.picRenderer,
        game = me.game,
        camera = me.camera,
        uiPlayer = me.uiPlayer;

        canvas = me.piCanvas;
        canvas.init(gameStage);
        gameLayer = canvas.addLayer('game');

        renderer.registerContext('viewPane', gameLayer.getContext());
        renderer.registerContext('uiPane', gameLayer.getContext());

        reactor = me.piReactor.create();

        reactor.addPath(0, [game.update, renderer.draw]);
        reactor.route('move', [game.explore, renderer.draw]);
        reactor.route('init', [game.init, renderer.draw]);
        reactor.route('resize', [camera.resize, uiPlayer.resize, renderer.draw]);

        cameraEnt = reactor.createEntity('camera');
        uiPlayerEnt = reactor.createEntity('uiPlayer');

        cameraEnt.attach(camera, {world:game.moduleName});
        cameraEnt.attach(renderer, {viewPane:[camera.moduleName]});
        uiPlayerEnt.attach(uiPlayer, {world:game.moduleName});
        uiPlayerEnt.attach(renderer, {uiPane:[uiPlayer.moduleName]});

        onResize.call(window);
        reactor.go('init', {tileSet:tileSet, tileWidth:64, tileHeight:64, mapWidth:8, mapHeight:8, mapLevel:0, heroJob:G_HERO.PRIEST});
        canvas.slot(canvas.ON_FINGER_DOWN, onMouseDown);
        window.addEventListener('resize', onResize, false);
        //window.addEventListener('deviceorientation', onRotate, true);
    });
};

me.slot(pico.LOAD, onLoad);
</script>
